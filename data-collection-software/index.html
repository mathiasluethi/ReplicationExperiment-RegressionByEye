<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Slider Example</title>

        <link rel="stylesheet" href="styles.css"/>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>

    </head>
    <body>

        <canvas id="myCanvas" width="300" height="525"></canvas>

        <div class="history">
            <span>m = </span>
            <span id="demo"></span>
        </div>

        <div class="slidecontainer">
            <input type="range" min="-1" max="1" step="0.01" value="0" class="slider" id="myRange">
        </div>

        <div class="buttonContainer">
            <button type="button" onclick="previous()">Previous</button>
            <button type="button" onclick="next()">Next</button>
        </div>



        <script type="text/javascript">

            let slider = document.getElementById("myRange");
            let output = document.getElementById("demo");

            let canvas = document.getElementById("myCanvas");
            ctxb = canvas.getContext("2d");

            output.innerHTML = slider.value;

            let data;
            let taskIndex = 0;
            let task;
            let background;
            let line;
            let correctGraphSlope;
            let sliderValue;
            let x0, x1, y0, y1;

            setupExperiment();

            // Setup experiment
            async function setupExperiment() {
                let d = loadData();
                data = await d;

                newGraph();
            }

            function newGraph() {
                task = data[taskIndex];
                line = task.graphtype;
                slider.value = 0;
                output.innerHTML = 0;
                loadImage(task);
                correctGraphSlope = task.m;
            }

            // Load in the csv file and convert it to an object
            async function loadData() {
                let data = $.get("./data/csvs/P1.csv").then(function(csv){
                    var lines = csv.split("\n");
                    var result = [];
                    var headers = lines[0].split(",");

                    for(var i=1; i<lines.length; i++){
                        var obj = {};
                        var currentline = lines[i].split(",");

                        for(var j=0; j<headers.length; j++){
                            obj[headers[j]] = currentline[j];
                        }

                        result.push(obj);
                    }
                    return result; 
                });
                return await data;
            }
            
            // Load images
            function loadImage(task) {
                background = new Image();
                background.src = task.src;

                // Make sure the image is loaded first otherwise nothing will draw.
                background.onload = function(){
                    ctxb.drawImage(background,0,0,300,525);   
                }
            }
            
            // Update the current slider value (each time you drag the slider handle)
            slider.oninput = function() {
                sliderValue = this.value;
                output.innerHTML = sliderValue;
                x1 = 0;
                y1 = 262.5 + 150 * this.value;
                x2 = 300
                y2 = 262.5 + -150 * this.value;
                if (line === "line") {
                    drawLinearRegression(x1, x2, y1, y2);
                } else if (line === "quad") {
                    drawLine();
                }
            }

            // Change the data based on input and move to the new task
            function next() {
                data[taskIndex].answer = slider.value;
                // data[taskIndex].error = slider.value - data[taskIndex].m;
                
                taskIndex = taskIndex + 1;
                
                newGraph();
            }

            // Change the data based on input and move to the new task
            function previous() {
                if (taskIndex >= 1) {
                    data[taskIndex].answer = slider.value;
                
                    taskIndex = taskIndex - 1;
                    
                    newGraph();
                } else {
                    alert("You can't move back. This is the first task.")
                }
            }

            // Canvas drawing logic
            function drawLinearRegression(x1, x2, y1, y2) {
                let ctx = canvas.getContext("2d");
                ctx.clearRect(0, 0, 300, 525);
                ctxb.drawImage(background,0,0,300,525);  
                ctx.beginPath();
                ctx.moveTo(x1, y1);
                ctx.lineTo(x2, y2);
                ctx.stroke();
            }

            function fun1(x) {
                a = sliderValue; // the curvature
                b = correctGraphSlope; // the existing linear slope of the graph
                c = 0; // where 0 point is
                if (sliderValue >= 0) {
                quadraticFunction = (Math.pow(a*x, 2)+b*x+c);
                } else {
                quadraticFunction = -(Math.pow(a*x, 2)-b*x+c);
                }
                return quadraticFunction;
            }

            function drawLine() {
                var canvas = document.getElementById("myCanvas");
                if (null==canvas || !canvas.getContext) return;

                var axes={}, ctx=canvas.getContext("2d");
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctxb.drawImage(background,0,0,ctx.canvas.width,ctx.canvas.height); 
                // position of axes (in the middle of canvas)
                axes.x0 = .5 + .5*canvas.width;  // x0 pixels from left to x=0
                axes.y0 = .5 + .5*canvas.height; // y0 pixels from top to y=0
                axes.scale = 40;                 // 40 pixels from x=0 to x=1 (length of graph, scaled up)
                axes.doNegativeX = true;
                drawQuadraticGraph(ctx)
                // funGraph(ctx,axes,fun1,"black",2); 
            }

            function drawQuadraticGraph (ctx) {
                let m = correctGraphSlope;
                let b = scale(m, -1, 1, 1, 0);
                let resolution = 100;
                let X1;
                let Y1;
                let X2;
                let Y2;
                ctx.beginPath();
                ctx.lineWidth = 3;
                ctx.strokeStyle = 'black';
                for (var i = 0; i<resolution; i++) {
                    X1 = scale(i, 0, resolution, 0, 1);
                    Y1 = m*Math.sqrt(X1)+b;
                    X2 = scale(i+1, 0, resolution, 0, 1);
                    Y2 = m*Math.sqrt(X2)+b;
                // move to starting position
                if (i==0) ctx.moveTo(i*300,Y1*525);
                // start drawing
                else ctx.lineTo(X2*300,Y2*525);
                }
                ctx.stroke();
            }

            const scale = (num, in_min, in_max, out_min, out_max) => {
                return (num - in_min) * (out_max - out_min) / (in_max - in_min) + out_min;
            }

            function funGraph (ctx,axes,func,color,thick) {
                var xx, yy, dx=4, x0=axes.x0, y0=axes.y0, scale=axes.scale;
                var iMax = Math.round((ctx.canvas.width-x0)/dx);
                var iMin = axes.doNegativeX ? Math.round(-x0/dx) : 0;
                ctx.beginPath();
                ctx.lineWidth = thick;
                ctx.strokeStyle = color;

                for (var i=iMin;i<=iMax;i++) {
                    xx = dx*i; yy = scale*func(xx/scale,2);
                    if (i==iMin) ctx.moveTo(x0+xx,y0-yy);
                    else         ctx.lineTo(x0+xx,y0-yy);
                }
                ctx.stroke();
            }
            
        </script>

    </body>
</html>
